<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Project,Web Application,Socket," />





  <link rel="alternate" href="/atom.xml" title="Take A Leap" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="BackgroundThis is a course project of 18652-Foundation Of Software Engineering in Carnegie Mellon University Silicon Valley Campus. It aims to build a web application using some specific techniques in">
<meta property="og:type" content="article">
<meta property="og:title" content="Chat Room System Design">
<meta property="og:url" content="http://yoursite.com/2017/12/19/Chatroom-1/index.html">
<meta property="og:site_name" content="Take A Leap">
<meta property="og:description" content="BackgroundThis is a course project of 18652-Foundation Of Software Engineering in Carnegie Mellon University Silicon Valley Campus. It aims to build a web application using some specific techniques in">
<meta property="og:image" content="http://yoursite.com/images/20171219_Chatroom_System_Design_1.png">
<meta property="og:image" content="http://yoursite.com/images/20171219_Chatroom_System_Design_2.png">
<meta property="og:updated_time" content="2017-12-20T08:42:27.350Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chat Room System Design">
<meta name="twitter:description" content="BackgroundThis is a course project of 18652-Foundation Of Software Engineering in Carnegie Mellon University Silicon Valley Campus. It aims to build a web application using some specific techniques in">
<meta name="twitter:image" content="http://yoursite.com/images/20171219_Chatroom_System_Design_1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/12/19/Chatroom-1/"/>





  <title> Chat Room System Design | Take A Leap </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Take A Leap</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/19/Chatroom-1/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="张俊">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Take A Leap">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Take A Leap" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Chat Room System Design
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-19T16:21:09+08:00">
                2017-12-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CMU-Course-Project/" itemprop="url" rel="index">
                    <span itemprop="name">CMU Course Project</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h3><p>This is a course project of 18652-Foundation Of Software Engineering in Carnegie Mellon University Silicon Valley Campus. It aims to build a web application using some specific techniques including JavaScript, Node.js, express.js and so on.</p>
<h3 id="Scenerio"><a href="#Scenerio" class="headerlink" title="Scenerio"></a>Scenerio</h3><p>Implement a simple web version of Chat Room, including functions:</p>
<ol>
<li>Regist and Login.</li>
<li>Post messages in chat room.</li>
<li>See other users’ chat messages.</li>
<li>Leave the chat room.</li>
<li>Reload history messages when a user re-enters the chat room.</li>
</ol>
<h3 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h3><p>After figuring out the scenerio, it is easy to figure out an initial system architecture diagram.</p>
<p><img src="/images/20171219_Chatroom_System_Design_1.png" alt="system_architecture_diagram_1"></p>
<p>In the diagram, the users are divided into two pools: Online pool and Offline pool. The Webserver will build long connection with each online user and inform them with new messages posted by other users immediately. Correspondingly, online users can post messages to the Webserver which will be seen by others.</p>
<p>But which pool will a user belong to? </p>
<p><img src="/images/20171219_Chatroom_System_Design_2.png" alt="system_architecture_diagram_2"></p>
<p>An offline user will become an online user by <strong>signing in</strong> and will return to offline status by <strong>leaving</strong>. <strong>Leaving</strong> means turning off the browser or signing out. Once a new user have registered successful, this user will automaticly login and become an online user.</p>
<h3 id="Technique"><a href="#Technique" class="headerlink" title="Technique"></a>Technique</h3><pre><code>Webserver: express.js
Database: Mysql
Frontend: Bootstrap
Socket: socket.io
</code></pre><h3 id="Extensibility"><a href="#Extensibility" class="headerlink" title="Extensibility"></a>Extensibility</h3><h4 id="Growth-of-Users"><a href="#Growth-of-Users" class="headerlink" title="Growth of Users"></a>Growth of Users</h4><p>If we have a good fortune, millions of users love and join our Online Chat Room, the rapid growth of users will make our server under pressure. </p>
<p>Let’s say there are 1 million registered users and at most 30% of them (300,000) will be online concurrently. In average, at most 20% of online users (60,000) will post in one second.</p>
<p>On this occation, many problems will occur:</p>
<ol>
<li>One webserver could not keep 300,000 connections and process such great amounts of queries. </li>
<li>The Mysql server will have a high load and refuse most of queries.</li>
<li>The messages will have a long time latency and even be able to be lost. </li>
</ol>
<h4 id="1-Connections"><a href="#1-Connections" class="headerlink" title="1. Connections"></a>1. Connections</h4><p>We need more servers to provide connections. Assume each server could establish 500 connections, then we will need 300000/500 = <strong>600</strong> servers. </p>
<p>When we try to inform the users with new posts, we must know which users should be sent and where the connections are. So it is necessary to store the status  of connections like this: </p>
<table>
<thead>
<tr>
<th style="text-align:center">User</th>
<th style="text-align:center">Instance</th>
<th style="text-align:center">UpdateTime</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Sam</td>
<td style="text-align:center">100.ChatRoom.bj</td>
<td style="text-align:center">2017-12-20 13:26:00</td>
</tr>
<tr>
<td style="text-align:center">Peter</td>
<td style="text-align:center">200.ChatRoom.ca</td>
<td style="text-align:center">2017-12-20 14:26:00</td>
</tr>
<tr>
<td style="text-align:center">Maria</td>
<td style="text-align:center">300.ChatRoom.pa</td>
<td style="text-align:center">2017-12-20 16:30:00</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Instance is named by ${instanceId}.${product}.${idc} </p>
</blockquote>
<p>Now, we know who we should inform and where to find them as long as this table is constantly updating.</p>
<h4 id="2-Storage"><a href="#2-Storage" class="headerlink" title="2. Storage"></a>2. Storage</h4><h4 id="3-Messages"><a href="#3-Messages" class="headerlink" title="3. Messages"></a>3. Messages</h4><h4 id="Multiple-Rooms"><a href="#Multiple-Rooms" class="headerlink" title="Multiple Rooms"></a>Multiple Rooms</h4><p>With the growth of users, they would have many other requirements. One of them will be Multiple Room, after all we can not have all of users intermixed in one room.</p>
<p>Then, it is necessary to allow users to establish and enter different rooms as they wish.</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/uploads/weixin_pay.jpg" alt="张俊 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/uploads/ali_pay.jpg" alt="张俊 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Project/" rel="tag"># Project</a>
          
            <a href="/tags/Web-Application/" rel="tag"># Web Application</a>
          
            <a href="/tags/Socket/" rel="tag"># Socket</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/16/Leetcode-Solution-208-211-Trie-Prefix-Tree/" rel="next" title="208. 211. Trie(Prefix Tree)">
                <i class="fa fa-chevron-left"></i> 208. 211. Trie(Prefix Tree)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.png"
               alt="张俊" />
          <p class="site-author-name" itemprop="name">张俊</p>
          <p class="site-description motion-element" itemprop="description">一个人的命运，当然要靠自我奋斗，但是也要考虑历史的进程</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/EugeneOrzie" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1991852397" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/jun-zhang-6b359a104/" target="_blank" title="linkedin">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  linkedin
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://fredxue.com/" title="Fred" target="_blank">Fred</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Background"><span class="nav-number">1.</span> <span class="nav-text">Background</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Scenerio"><span class="nav-number">2.</span> <span class="nav-text">Scenerio</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Architecture"><span class="nav-number">3.</span> <span class="nav-text">Architecture</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Technique"><span class="nav-number">4.</span> <span class="nav-text">Technique</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Extensibility"><span class="nav-number">5.</span> <span class="nav-text">Extensibility</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Growth-of-Users"><span class="nav-number">5.1.</span> <span class="nav-text">Growth of Users</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-Connections"><span class="nav-number">5.2.</span> <span class="nav-text">1. Connections</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-Storage"><span class="nav-number">5.3.</span> <span class="nav-text">2. Storage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-Messages"><span class="nav-number">5.4.</span> <span class="nav-text">3. Messages</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Multiple-Rooms"><span class="nav-number">5.5.</span> <span class="nav-text">Multiple Rooms</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张俊</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  

  

  

  

  


</body>
</html>
